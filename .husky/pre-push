#!/bin/bash
INPUT_DIR="resources/js"
OUTPUT_DIR="public/build"
LOCKFILE="/tmp/pre-push.lock"

# Prevent overlapping builds
exec 9>$LOCKFILE
if ! flock -n 9; then
  echo "âŒ Another push is already being processed."
  exit 1
fi

echo "ğŸ” Checking for changes in $INPUT_DIR..."
CHANGED_JS=$(git diff --cached --name-only | grep -E "^$INPUT_DIR/.*\.(js|ts|vue)$")
if [ -z "$CHANGED_JS" ]; then
  echo "âœ… No JS changes detected. Skipping build."
  exit 0
fi

echo "ğŸ“¦ JS changes detected. Running build..."
if ! command -v vite >/dev/null; then
  echo "âŒ Vite is not installed. Please install it before continuing."
  exit 1
fi

if ! npm run build; then
  echo "âŒ Build failed. Push blocked."
  exit 1
fi

echo "ğŸ” Verifying changes in $OUTPUT_DIR..."
if git diff --quiet HEAD $OUTPUT_DIR; then
  echo "âœ… Build succeeded but no changes detected in $OUTPUT_DIR."
  exit 0
fi

echo "ğŸ“ Detected changes in $OUTPUT_DIR â€” staging them..."
git add -A $OUTPUT_DIR
echo "ğŸ“ Committing updated build..."
git commit -m "chore: update Vite build (auto-commit from pre-push)"

echo "âœ… Build succeeded and changes committed. Proceeding with push."
